{% extends 'base.html' %}
{% load currency_filters %}
{% block content %}
<div class="dashboard-container">
  <div class="header-section p-4 soft-section">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <div>
        <h2 class="fw-bold text-dark mb-1">Welcome, {{ request.user.get_display_name|default:request.user.email }}!</h2>
        <p class="text-muted mb-0">Manage your orders and activity</p>
      </div>
      {% if request.user.role == 'tailor' %}
      <div class="d-flex align-items-center gap-3">
        <span class="text-muted">Availability Status</span>
        <a href="{% url 'accounts:update_availability' %}" class="btn btn-sm btn-outline-success">{% if request.user.is_available %}Available{% else %}Set Availability{% endif %}</a>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="summary-cards row g-3 mb-4">
    <div class="col-md-3">
      <div class="card h-100 rounded-4 p-3 d-flex flex-row align-items-center">
        <div class="flex-grow-1">
          <p class="text-muted mb-0">Pending</p>
          <h4 class="fw-bold">{% with orders|length as count %}{{ count }}{% endwith %}</h4>
        </div>
        <span class="icon-circle bg-light-yellow text-yellow"><i class="bi bi-clock"></i></span>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 rounded-4 p-3 d-flex flex-row align-items-center">
        <div class="flex-grow-1">
          <p class="text-muted mb-0">In Progress</p>
          <h4 class="fw-bold">—</h4>
        </div>
        <span class="icon-circle bg-light-blue text-blue"><i class="bi bi-box"></i></span>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 rounded-4 p-3 d-flex flex-row align-items-center">
        <div class="flex-grow-1">
          <p class="text-muted mb-0">Completed</p>
          <h4 class="fw-bold">—</h4>
        </div>
        <span class="icon-circle bg-light-green text-green"><i class="bi bi-check2-circle"></i></span>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 rounded-4 p-3 d-flex flex-row align-items-center">
        <div class="flex-grow-1">
          <p class="text-muted mb-0">Rating</p>
          <h4 class="fw-bold">—</h4>
        </div>
        <span class="icon-circle bg-light-yellow text-yellow"><i class="bi bi-star"></i></span>
      </div>
    </div>
  </div>

  <ul class="nav nav-pills mb-4" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="my-orders-tab" data-bs-toggle="tab" data-bs-target="#my-orders" type="button" role="tab" aria-controls="my-orders" aria-selected="true">My Orders</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab" aria-controls="notifications" aria-selected="false">Notifications</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Profile</button>
    </li>
  </ul>

  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="my-orders" role="tabpanel" aria-labelledby="my-orders-tab">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold text-dark mb-0">My Orders</h3>
        <a href="{% url 'orders:category_selection' %}" class="btn btn-warning fw-bold"><i class="bi bi-plus-lg me-2"></i>New Order</a>
      </div>

      {% if orders %}
        {% for order in orders %}
        <div class="card rounded-4 mb-3 p-3">
          <div class="row align-items-center">
            <div class="col-md-6">
              <h5 class="fw-bold mb-1">ORD-{{ order.id }}</h5>
              <p class="text-muted mb-1">{{ order.category.name }}</p>
              <p class="mb-0"><small>Tailor: {% if order.assigned_tailor %}{{ order.assigned_tailor.email }}{% else %}Not Assigned{% endif %}</small></p>
            </div>
            <div class="col-md-6 text-md-end">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <p class="text-muted mb-0"><small>Submitted</small></p>
                  <p class="fw-bold mb-0">{{ order.created_at|date:"Y-m-d" }}</p>
                </div>
                <div>
                  <p class="text-muted mb-0"><small>Expected</small></p>
                  <p class="fw-bold mb-0">N/A</p>
                </div>
                <div>
                  <p class="text-muted mb-0"><small>Amount</small></p>
                  <p class="fw-bold mb-0">{% if order.price_cents %}{{ order.price_cents|currency_cents:'LKR' }}{% else %}—{% endif %}</p>
                </div>
                <div>
                  <span class="badge bg-{{ order.status|lower }} me-2">{{ order.get_status_display }}</span>
                </div>
              </div>
              <a href="{% url 'orders:order_detail' order_id=order.id %}" class="btn btn-sm btn-outline-secondary mt-2">View Details</a>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
      <div class="alert alert-info text-center" role="alert">
        You haven't placed any orders yet. Click 'New Order' to get started!
      </div>
      {% endif %}
    </div>
    <div class="tab-pane fade" id="notifications" role="tabpanel" aria-labelledby="notifications-tab">
      {% if notifications %}
        <ul class="list-group mb-3">
          {% for n in notifications %}
            <li class="list-group-item d-flex justify-content-between align-items-start {% if not n.is_read %}list-group-item-warning{% endif %}">
              <div class="ms-2 me-auto">
                <div class="fw-bold">{{ n.timestamp|date:"Y-m-d H:i" }}</div>
                {{ n.message }}
              </div>
              {% if not n.is_read %}
                <a href="{% url 'accounts:mark_notification_read' n.id %}" class="btn btn-sm btn-outline-secondary">Mark as read</a>
              {% else %}
                <span class="badge bg-secondary">Read</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="alert alert-info">No notifications yet.</div>
      {% endif %}
    </div>
    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
      {% include 'accounts/profile_content.html' %}
    </div>
  </div>
</div>
{% endblock %}
