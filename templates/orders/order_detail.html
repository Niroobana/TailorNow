{% extends 'base.html' %}
{% load currency_filters %}
{% block content %}
<div class="container py-5">
  <h2 class="text-center fw-bold mb-4">Order Details (Order #{{ order.id }})</h2>
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body p-4">
          <p><strong>Category:</strong> {{ order.category.name }}</p>
          <p><strong>Status:</strong> <span class="badge bg-primary">{{ order.get_status_display }}</span> {% if order.is_urgent %}<span class="badge bg-danger ms-2">Urgent</span>{% endif %}</p>
          <p><strong>Submitted On:</strong> {{ order.created_at|date:"M d, Y H:i" }}</p>
          {% if order.assigned_tailor %}
            <p><strong>Assigned Tailor:</strong> {{ order.assigned_tailor.email }}</p>
          {% else %}
            <p><strong>Assigned Tailor:</strong> Not yet assigned</p>
          {% endif %}
          <hr>
          <h4>Details</h4>
          <p><strong>Measurements:</strong><br>{{ order.measurements|linebreaksbr }}</p>
          <p><strong>Fabric Info:</strong><br>{{ order.fabric_info|linebreaksbr }}</p>
          {% if order.reference_photo %}
            <h5>Reference Photo:</h5>
            <img src="{{ order.reference_photo.url }}" class="img-fluid rounded" alt="Reference Photo" style="max-height: 300px; object-fit: cover;">
          {% else %}
            <p>No reference photo provided.</p>
          {% endif %}
          <div class="mt-4 text-center">
            {% if request.user.role == 'customer' and order.status != 'cancelled' %}
              {% if not order.is_paid and order.price_cents %}
                <a class="btn btn-primary me-2" href="{% url 'payments:checkout' order_id=order.id %}">Pay Now ({{ order.price_cents|currency_cents:'LKR' }})</a>
              {% else %}
                {% if order.is_paid %}
                <span class="badge bg-success me-2">Paid ({{ order.price_cents|currency_cents:'LKR' }})</span>
                {% endif %}
              {% endif %}
            {% endif %}
            {% if request.user.role == 'tailor' and order.assigned_tailor == request.user %}
              {% if order.status == 'pending' or order.status == 'assigned' %}
              <form method="post" style="display:inline-block;">
                {% csrf_token %}
                <button type="submit" name="action" value="accept" class="btn btn-success me-2">Accept Job</button>
              </form>
              <form method="post" style="display:inline-block;">
                {% csrf_token %}
                <button type="submit" name="action" value="reject" class="btn btn-danger me-2">Reject Job</button>
              </form>
              {% endif %}

              {% if order.status == 'assigned' %}
              <form method="post" style="display:inline-block;">
                {% csrf_token %}
                <button type="submit" name="action" value="mark_in_progress" class="btn btn-info me-2">Mark In Progress</button>
              </form>
              {% endif %}

              {% if order.status == 'in_progress' %}
              <form method="post" style="display:inline-block;">
                {% csrf_token %}
                <button type="submit" name="action" value="mark_completed" class="btn btn-success me-2">Mark Completed</button>
              </form>
              {% endif %}
            {% endif %}

            {% if request.user.role == 'customer' %}
            {% if not order.dispute %}
            <a href="{% url 'orders:raise_dispute' order_id=order.id %}" class="btn btn-danger me-2">Raise Dispute</a>
            {% else %}
            <button class="btn btn-secondary me-2" disabled>Dispute Raised</button>
            {% endif %}
            {% if order.status == 'completed' and not order.feedback %}
            <a href="{% url 'orders:submit_feedback' order_id=order.id %}" class="btn btn-success me-2">Leave Feedback</a>
            {% endif %}
            <a href="{% url 'accounts:dashboard' %}" class="btn btn-secondary me-2">Back to Dashboard</a>
            {% elif request.user.role == 'tailor' %}
            <a href="{% url 'orders:tailor_assigned_orders' %}" class="btn btn-secondary me-2">Back to Assigned Jobs</a>
            {% endif %}
            <a href="#" class="btn btn-info">Track Status (coming soon)</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

